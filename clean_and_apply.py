#!/usr/bin/env python3
"""
ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ 8ì›” ë‚¨ì€ ê¸°ê°„ ê³„íší‘œ ì ìš©
"""

import psycopg2

def get_db_connection():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    return psycopg2.connect(
        host="aws-0-ap-northeast-2.pooler.supabase.com",
        database="postgres", 
        user="postgres.lhqzjnpwuftaicjurqxq",
        password="Unbleyum1106!",
        port=5432
    )

def clean_and_apply():
    """ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ìƒˆ ê³„íší‘œ ì ìš©"""
    
    conn = None
    cursor = None
    
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        print("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ")
        
        # 1. ê¸°ì¡´ 8ì›” 26-31ì¼ ë°ì´í„° ì‚­ì œ
        print("\n1. ê¸°ì¡´ 8ì›” 26-31ì¼ ë°ì´í„° ì‚­ì œ...")
        cursor.execute("DELETE FROM unble.publishing_schedule WHERE week_start_date = '2025-08-25' AND day_of_week >= 1")
        deleted_count = cursor.rowcount
        print(f"ì‚­ì œëœ ê¸°ì¡´ ë°ì´í„°: {deleted_count}ê°œ")
        
        # 2. ìƒˆë¡œìš´ ê³„íší‘œ ë°ì´í„° ì‚½ì…
        print("\n2. ìƒˆë¡œìš´ ê³„íší‘œ ë°ì´í„° ì‚½ì…...")
        
        # 8/26-31 ìƒˆ ê³„íší‘œ ë°ì´í„°
        new_schedule = [
            # 8ì›” 26ì¼ (í™”ìš”ì¼, day_of_week=1)
            ('2025-08-25', 1, 'unpre', 'ê¸°ìˆ /ë””ì§€í„¸', 'Python ì›¹ í¬ë¡¤ë§ ë§ˆìŠ¤í„°í•˜ê¸°', ['Python', 'ì›¹', 'í¬ë¡¤ë§']),
            ('2025-08-25', 1, 'untab', 'ì¬ì •/íˆ¬ì', 'ì›” 100ë§Œì› ë°°ë‹¹ê¸ˆ í¬íŠ¸í´ë¦¬ì˜¤', ['ì›”', '100ë§Œì›', 'ë°°ë‹¹ê¸ˆ']),
            ('2025-08-25', 1, 'skewese', 'ê±´ê°•/ì›°ë‹ˆìŠ¤', 'í”¼ë¶€ íƒ€ì…ë³„ ìŠ¤í‚¨ì¼€ì–´ ë£¨í‹´', ['í”¼ë¶€', 'íƒ€ì…ë³„', 'ìŠ¤í‚¨ì¼€ì–´']),
            ('2025-08-25', 1, 'tistory', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'ë„·í”Œë¦­ìŠ¤ ìˆ¨ì€ ëª…ì‘ ì¶”ì²œ', ['ë„·í”Œë¦­ìŠ¤', 'ìˆ¨ì€', 'ëª…ì‘']),
            
            # 8ì›” 27ì¼ (ìˆ˜ìš”ì¼, day_of_week=2)
            ('2025-08-25', 2, 'unpre', 'ê¸°ìˆ /ë””ì§€í„¸', 'React 18 ìƒˆë¡œìš´ ê¸°ëŠ¥ ì™„ë²½ ì •ë¦¬', ['React', '18', 'ìƒˆë¡œìš´']),
            ('2025-08-25', 2, 'untab', 'ì¬ì •/íˆ¬ì', 'ë¶€ë™ì‚° ê²½ë§¤ ì´ˆë³´ì ê°€ì´ë“œ', ['ë¶€ë™ì‚°', 'ê²½ë§¤', 'ì´ˆë³´ì']),
            ('2025-08-25', 2, 'skewese', 'ê±´ê°•/ì›°ë‹ˆìŠ¤', 'í™ˆíŠ¸ë ˆì´ë‹ 4ì£¼ í”„ë¡œê·¸ë¨', ['í™ˆíŠ¸ë ˆì´ë‹', '4ì£¼', 'í”„ë¡œê·¸ë¨']),
            ('2025-08-25', 2, 'tistory', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'ì•„ì´ëŒ ì„œë°”ì´ë²Œ í”„ë¡œê·¸ë¨ ì •ë¦¬', ['ì•„ì´ëŒ', 'ì„œë°”ì´ë²Œ', 'í”„ë¡œê·¸ë¨']),
            
            # 8ì›” 28ì¼ (ëª©ìš”ì¼, day_of_week=3)
            ('2025-08-25', 3, 'unpre', 'ê¸°ìˆ /ë””ì§€í„¸', 'VS Code ìƒì‚°ì„± 200% ë†’ì´ëŠ” ìµìŠ¤í…ì…˜', ['VS', 'Code', 'ìƒì‚°ì„±']),
            ('2025-08-25', 3, 'untab', 'ì¬ì •/íˆ¬ì', 'ë¹„íŠ¸ì½”ì¸ ETF íˆ¬ì ì „ëµ', ['ë¹„íŠ¸ì½”ì¸', 'ETF', 'íˆ¬ì']),
            ('2025-08-25', 3, 'skewese', 'ê±´ê°•/ì›°ë‹ˆìŠ¤', 'ë‹¨ë°±ì§ˆ ë³´ì¶©ì œ ì„ íƒ ê°€ì´ë“œ', ['ë‹¨ë°±ì§ˆ', 'ë³´ì¶©ì œ', 'ì„ íƒ']),
            ('2025-08-25', 3, 'tistory', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'ì›¹íˆ° ì›ì‘ ë“œë¼ë§ˆ ì„±ê³µ ë¹„ê²°', ['ì›¹íˆ°', 'ì›ì‘', 'ë“œë¼ë§ˆ']),
            
            # 8ì›” 29ì¼ (ê¸ˆìš”ì¼, day_of_week=4)
            ('2025-08-25', 4, 'unpre', 'ê¸°ìˆ /ë””ì§€í„¸', 'Dockerë¡œ ê°œë°œí™˜ê²½ í†µì¼í•˜ê¸°', ['Dockerë¡œ', 'ê°œë°œí™˜ê²½', 'í†µì¼í•˜ê¸°']),
            ('2025-08-25', 4, 'untab', 'ì¬ì •/íˆ¬ì', 'ISA ê³„ì¢Œ 200% í™œìš©ë²•', ['ISA', 'ê³„ì¢Œ', '200%']),
            ('2025-08-25', 4, 'skewese', 'ê±´ê°•/ì›°ë‹ˆìŠ¤', 'ìˆ˜ë©´ì˜ ì§ˆ ë†’ì´ëŠ” 10ê°€ì§€ ë°©ë²•', ['ìˆ˜ë©´ì˜', 'ì§ˆ', 'ë†’ì´ëŠ”']),
            ('2025-08-25', 4, 'tistory', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'K-POP 4ì„¸ëŒ€ ê·¸ë£¹ ë¶„ì„', ['K-POP', '4ì„¸ëŒ€', 'ê·¸ë£¹']),
            
            # 8ì›” 30ì¼ (í† ìš”ì¼, day_of_week=5)
            ('2025-08-25', 5, 'unpre', 'ê¸°ìˆ /ë””ì§€í„¸', 'Git ë¸Œëœì¹˜ ì „ëµ ì‹¤ë¬´ ê°€ì´ë“œ', ['Git', 'ë¸Œëœì¹˜', 'ì „ëµ']),
            ('2025-08-25', 5, 'untab', 'ì¬ì •/íˆ¬ì', 'ë¯¸êµ­ ì£¼ì‹ ì„¸ê¸ˆ ì ˆì•½ íŒ', ['ë¯¸êµ­', 'ì£¼ì‹', 'ì„¸ê¸ˆ']),
            ('2025-08-25', 5, 'skewese', 'ê±´ê°•/ì›°ë‹ˆìŠ¤', 'ê¸€ë£¨í…í”„ë¦¬ ë‹¤ì´ì–´íŠ¸ íš¨ê³¼', ['ê¸€ë£¨í…í”„ë¦¬', 'ë‹¤ì´ì–´íŠ¸', 'íš¨ê³¼']),
            ('2025-08-25', 5, 'tistory', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'OTT í”Œë«í¼ë³„ íŠ¹ì§• ë¹„êµ', ['OTT', 'í”Œë«í¼ë³„', 'íŠ¹ì§•']),
            
            # 8ì›” 31ì¼ (ì¼ìš”ì¼, day_of_week=6)
            ('2025-08-25', 6, 'unpre', 'ê¸°ìˆ /ë””ì§€í„¸', 'AWS Lambda ì„œë²„ë¦¬ìŠ¤ ì…ë¬¸', ['AWS', 'Lambda', 'ì„œë²„ë¦¬ìŠ¤']),
            ('2025-08-25', 6, 'untab', 'ì¬ì •/íˆ¬ì', 'ë¦¬ì¸ (REITs) íˆ¬ì ì™„ë²½ ê°€ì´ë“œ', ['ë¦¬ì¸ (REITs)', 'íˆ¬ì', 'ì™„ë²½']),
            ('2025-08-25', 6, 'skewese', 'ê±´ê°•/ì›°ë‹ˆìŠ¤', 'ìš”ê°€ ì´ˆë³´ì ê¸°ë³¸ ìì„¸', ['ìš”ê°€', 'ì´ˆë³´ì', 'ê¸°ë³¸']),
            ('2025-08-25', 6, 'tistory', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'í•œêµ­ ì˜í™” ì—­ëŒ€ í¥í–‰ TOP 20', ['í•œêµ­', 'ì˜í™”', 'ì—­ëŒ€'])
        ]
        
        # ê° ì‚¬ì´íŠ¸ë³„ secondary ì¹´í…Œê³ ë¦¬
        secondary_schedule = [
            # 8ì›” 26ì¼ Secondary
            ('2025-08-25', 1, 'unpre', 'êµìœ¡/ìê¸°ê³„ë°œ', 'ê°œë°œì ì´ë ¥ì„œ ì‘ì„± ì™„ë²½ ê°€ì´ë“œ', ['ê°œë°œì', 'ì´ë ¥ì„œ', 'ì‘ì„±']),
            ('2025-08-25', 1, 'untab', 'ë¼ì´í”„ìŠ¤íƒ€ì¼', 'ì›ë£¸ ì¸í…Œë¦¬ì–´ 10ë§Œì›ìœ¼ë¡œ ë³€ì‹ ', ['ì›ë£¸', 'ì¸í…Œë¦¬ì–´', '10ë§Œì›ìœ¼ë¡œ']),
            ('2025-08-25', 1, 'skewese', 'ì—­ì‚¬/ë¬¸í™”', 'í•œêµ­ ì „ìŸ ìˆ¨ê²¨ì§„ ì´ì•¼ê¸°', ['í•œêµ­', 'ì „ìŸ', 'ìˆ¨ê²¨ì§„']),
            ('2025-08-25', 1, 'tistory', 'íŠ¸ë Œë“œ/ì´ìŠˆ', 'AIê°€ ë°”ê¾¸ëŠ” ì¼ìƒìƒí™œ', ['AIê°€', 'ë°”ê¾¸ëŠ”', 'ì¼ìƒìƒí™œ']),
            
            # 8ì›” 27ì¼ Secondary
            ('2025-08-25', 2, 'unpre', 'êµìœ¡/ìê¸°ê³„ë°œ', 'ì½”ë”©í…ŒìŠ¤íŠ¸ ë¹ˆì¶œ ì•Œê³ ë¦¬ì¦˜ ì •ë¦¬', ['ì½”ë”©í…ŒìŠ¤íŠ¸', 'ë¹ˆì¶œ', 'ì•Œê³ ë¦¬ì¦˜']),
            ('2025-08-25', 2, 'untab', 'ë¼ì´í”„ìŠ¤íƒ€ì¼', 'ì—ì–´í”„ë¼ì´ì–´ ë§ŒëŠ¥ ë ˆì‹œí”¼ 30ì„ ', ['ì—ì–´í”„ë¼ì´ì–´', 'ë§ŒëŠ¥', 'ë ˆì‹œí”¼']),
            ('2025-08-25', 2, 'skewese', 'ì—­ì‚¬/ë¬¸í™”', 'ì„¸ì¢…ëŒ€ì™•ì˜ ë¦¬ë”ì‹­ ë¶„ì„', ['ì„¸ì¢…ëŒ€ì™•ì˜', 'ë¦¬ë”ì‹­', 'ë¶„ì„']),
            ('2025-08-25', 2, 'tistory', 'íŠ¸ë Œë“œ/ì´ìŠˆ', 'ì¹œí™˜ê²½ ë¼ì´í”„ìŠ¤íƒ€ì¼ ì‹¤ì²œë²•', ['ì¹œí™˜ê²½', 'ë¼ì´í”„ìŠ¤íƒ€ì¼', 'ì‹¤ì²œë²•']),
            
            # 8ì›” 28ì¼ Secondary
            ('2025-08-25', 3, 'unpre', 'êµìœ¡/ìê¸°ê³„ë°œ', 'JLPT N2 í•œ ë²ˆì— í•©ê²©í•˜ê¸°', ['JLPT', 'N2', 'í•œ']),
            ('2025-08-25', 3, 'untab', 'ë¼ì´í”„ìŠ¤íƒ€ì¼', 'ìœ ëŸ½ ë°°ë‚­ì—¬í–‰ 2ì£¼ ì½”ìŠ¤', ['ìœ ëŸ½', 'ë°°ë‚­ì—¬í–‰', '2ì£¼']),
            ('2025-08-25', 3, 'skewese', 'ì—­ì‚¬/ë¬¸í™”', 'ì„ì§„ì™œë€ 7ë…„ ì „ìŸ ì—°ëŒ€ê¸°', ['ì„ì§„ì™œë€', '7ë…„', 'ì „ìŸ']),
            ('2025-08-25', 3, 'tistory', 'íŠ¸ë Œë“œ/ì´ìŠˆ', 'ë©”íƒ€ë²„ìŠ¤ í”Œë«í¼ ë¹„êµ', ['ë©”íƒ€ë²„ìŠ¤', 'í”Œë«í¼', 'ë¹„êµ']),
            
            # 8ì›” 29ì¼ Secondary
            ('2025-08-25', 4, 'unpre', 'êµìœ¡/ìê¸°ê³„ë°œ', 'ê¸°ìˆ  ë©´ì ‘ ë‹¨ê³¨ ì§ˆë¬¸ 100ì„ ', ['ê¸°ìˆ ', 'ë©´ì ‘', 'ë‹¨ê³¨']),
            ('2025-08-25', 4, 'untab', 'ë¼ì´í”„ìŠ¤íƒ€ì¼', 'ë¯¸ë‹ˆë©€ ë¼ì´í”„ ì‹œì‘í•˜ê¸°', ['ë¯¸ë‹ˆë©€', 'ë¼ì´í”„', 'ì‹œì‘í•˜ê¸°']),
            ('2025-08-25', 4, 'skewese', 'ì—­ì‚¬/ë¬¸í™”', 'ê³ êµ¬ë ¤ ê´‘ê°œí† ëŒ€ì™• ì •ë³µì‚¬', ['ê³ êµ¬ë ¤', 'ê´‘ê°œí† ëŒ€ì™•', 'ì •ë³µì‚¬']),
            ('2025-08-25', 4, 'tistory', 'íŠ¸ë Œë“œ/ì´ìŠˆ', 'Zì„¸ëŒ€ ì‹ ì¡°ì–´ ì‚¬ì „', ['Zì„¸ëŒ€', 'ì‹ ì¡°ì–´', 'ì‚¬ì „']),
            
            # 8ì›” 30ì¼ Secondary
            ('2025-08-25', 5, 'unpre', 'êµìœ¡/ìê¸°ê³„ë°œ', 'ì˜ì–´ íšŒí™” ìŠ¤í”¼í‚¹ ì—°ìŠµë²•', ['ì˜ì–´', 'íšŒí™”', 'ìŠ¤í”¼í‚¹']),
            ('2025-08-25', 5, 'untab', 'ë¼ì´í”„ìŠ¤íƒ€ì¼', 'í™ˆì¹´í˜ ë¶„ìœ„ê¸° ë§Œë“¤ê¸°', ['í™ˆì¹´í˜', 'ë¶„ìœ„ê¸°', 'ë§Œë“¤ê¸°']),
            ('2025-08-25', 5, 'skewese', 'ì—­ì‚¬/ë¬¸í™”', 'ì‹ ë¼ í™”ë‘ë„ ì •ì‹ ê³¼ ë¬¸í™”', ['ì‹ ë¼', 'í™”ë‘ë„', 'ì •ì‹ ê³¼']),
            ('2025-08-25', 5, 'tistory', 'íŠ¸ë Œë“œ/ì´ìŠˆ', 'ë¦¬ì…€ ì‹œì¥ ì¸ê¸° ì•„ì´í…œ', ['ë¦¬ì…€', 'ì‹œì¥', 'ì¸ê¸°']),
            
            # 8ì›” 31ì¼ Secondary
            ('2025-08-25', 6, 'unpre', 'êµìœ¡/ìê¸°ê³„ë°œ', 'ê°œë°œì í¬íŠ¸í´ë¦¬ì˜¤ ë§Œë“¤ê¸°', ['ê°œë°œì', 'í¬íŠ¸í´ë¦¬ì˜¤', 'ë§Œë“¤ê¸°']),
            ('2025-08-25', 6, 'untab', 'ë¼ì´í”„ìŠ¤íƒ€ì¼', 'ìº í•‘ ì´ˆë³´ì ì¥ë¹„ ë¦¬ìŠ¤íŠ¸', ['ìº í•‘', 'ì´ˆë³´ì', 'ì¥ë¹„']),
            ('2025-08-25', 6, 'skewese', 'ì—­ì‚¬/ë¬¸í™”', 'ë°±ì œ ë¬¸í™”ì¬ì˜ ì•„ë¦„ë‹¤ì›€', ['ë°±ì œ', 'ë¬¸í™”ì¬ì˜', 'ì•„ë¦„ë‹¤ì›€']),
            ('2025-08-25', 6, 'tistory', 'íŠ¸ë Œë“œ/ì´ìŠˆ', 'ìˆí¼ ì½˜í…ì¸  ì œì‘ íŒ', ['ìˆí¼', 'ì½˜í…ì¸ ', 'ì œì‘'])
        ]
        
        # Primary ì¹´í…Œê³ ë¦¬ ì‚½ì…
        for item in new_schedule:
            cursor.execute("""
                INSERT INTO unble.publishing_schedule 
                (week_start_date, day_of_week, site, topic_category, specific_topic, keywords, target_length, status) 
                VALUES (%s, %s, %s, %s, %s, %s, 'medium', 'planned')
            """, item)
        
        print(f"Primary ì¹´í…Œê³ ë¦¬ ì‚½ì…: {len(new_schedule)}ê°œ")
        
        conn.commit()
        print(f"ì„±ê³µ: ì´ {len(new_schedule)}ê°œ Primary ê³„íšì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
        
        print("\nâš ï¸ Secondary ì¹´í…Œê³ ë¦¬ëŠ” í˜„ì¬ í…Œì´ë¸” êµ¬ì¡°ìƒ ë³„ë„ ì²˜ë¦¬ í•„ìš”")
        print("ê° ì‚¬ì´íŠ¸ë³„ë¡œ í•˜ë£¨ì— 2ê°œ í¬ìŠ¤íŒ…(Primary + Secondary)ì„ ì›í•œë‹¤ë©´")
        print("í…Œì´ë¸” êµ¬ì¡° ë³€ê²½ì´ë‚˜ ë³„ë„ ì²˜ë¦¬ ë°©ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        
        # ê²°ê³¼ í™•ì¸
        cursor.execute("""
            SELECT week_start_date + INTERVAL '1 day' * day_of_week as calc_date, 
                   site, topic_category, specific_topic
            FROM unble.publishing_schedule 
            WHERE week_start_date = '2025-08-25' AND day_of_week >= 1
            ORDER BY day_of_week, site
        """)
        
        results = cursor.fetchall()
        print(f"\nì—…ë°ì´íŠ¸ëœ ê³„íší‘œ í™•ì¸: {len(results)}ê°œ")
        
        current_date = None
        for result in results:
            date, site, category, topic = result
            if current_date != date:
                current_date = date
                day_names = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']
                weekday = date.weekday()
                print(f"\nğŸ“… {date.strftime('%m/%d')}({day_names[weekday]}):")
            print(f"  {site.upper()}: [{category}] {topic}")
        
    except Exception as e:
        if conn:
            conn.rollback()
        print(f"ì˜¤ë¥˜: {e}")
        raise
    finally:
        if cursor:
            cursor.close()
        if conn:
            conn.close()

if __name__ == "__main__":
    clean_and_apply()