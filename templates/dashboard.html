<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="timestamp" content="2025-08-11-01-05">
    <meta name="version" content="bulk-delete-v2.1">
    <script>
        // 캐시 무효화를 위한 강제 새로고침
        if (performance.navigation.type !== 1) {
            console.log("강제 캐시 새로고침 실행");
        }
    </script>
    <title>블로그 자동화 대시보드 v2.1 (선택삭제 기능 추가)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .stat-card {
            padding: 20px;
            border-radius: 10px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255,255,255,0.1);
            transform: rotate(45deg);
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .stat-card p {
            margin: 0;
            opacity: 0.9;
        }
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .bg-gradient-success {
            background: linear-gradient(135deg, #48c774 0%, #3ec46d 100%);
        }
        .bg-gradient-info {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
        }
        .bg-gradient-warning {
            background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
        }
        .site-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 2px;
        }
        .site-unpre { background-color: #e3f2fd; color: #1976d2; }
        .site-untab { background-color: #e8f5e9; color: #388e3c; }
        .site-skewese { background-color: #fff3e0; color: #f57c00; }
        .site-tistory { background-color: #fce4ec; color: #c2185b; }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-online { background-color: #4caf50; }
        .status-offline { background-color: #f44336; }
        
        .log-entry {
            padding: 10px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .schedule-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            border-left: 4px solid #667eea;
        }
        
        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .tistory-file {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
        }
        
        .refresh-btn {
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* 스핀 애니메이션 추가 */
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 중앙 진행 과정 오버레이 */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .progress-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            min-width: 400px;
            max-width: 500px;
        }
        
        .progress-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }
        
        .progress-steps-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        
        .progress-step-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        
        .progress-step-item:last-child {
            border-bottom: none;
        }
        
        .progress-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            transition: all 0.3s ease;
        }
        
        .progress-step-icon.waiting {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            color: #6c757d;
        }
        
        .progress-step-icon.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .progress-step-icon.completed {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .progress-step-text {
            flex: 1;
            text-align: left;
            font-size: 1rem;
        }
        
        .progress-step-text.active {
            color: #667eea;
            font-weight: 600;
        }
        
        .progress-step-text.completed {
            color: #28a745;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        
        /* 로딩 스피너 개선 */
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        /* 업데이트 인디케이터 개선 */
        .update-indicator {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            margin: 10px 0;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .update-indicator .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        /* 선택삭제 기능 스타일 */
        .bulk-actions {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .bulk-actions.show {
            display: flex;
        }
        
        .bulk-info {
            display: flex;
            align-items: center;
        }
        
        .bulk-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .content-item {
            transition: all 0.3s ease;
        }
        
        .content-item.selected {
            background-color: #f8f9ff !important;
            border-color: #667eea !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .content-checkbox {
            transform: scale(1.2);
            margin-right: 10px;
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 16px !important;
            height: 16px !important;
        }
        
        .select-all-checkbox {
            transform: scale(1.3);
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 20px !important;
            height: 20px !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-robot"></i> 블로그 자동화 대시보드
            </span>
            <div class="text-white">
                <a href="/trending" class="btn btn-outline-light btn-sm me-3">
                    <i class="bi bi-graph-up"></i> 트렌딩
                </a>
                <span id="current-time"></span>
                <button class="btn btn-light btn-sm ms-3" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card bg-gradient-primary">
                    <h3 id="total-posts">0</h3>
                    <p>전체 포스트</p>
                    <i class="bi bi-file-text" style="position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-gradient-success">
                    <h3 id="today-posts">0</h3>
                    <p>오늘 발행</p>
                    <i class="bi bi-calendar-check" style="position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-gradient-info">
                    <h3 id="total-views">0</h3>
                    <p>총 조회수</p>
                    <i class="bi bi-eye" style="position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-gradient-warning">
                    <h3 id="total-revenue">₩0</h3>
                    <p>예상 수익</p>
                    <i class="bi bi-currency-dollar" style="position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-activity"></i> 시스템 상태</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="system-status">
                            <div class="col-md-3">
                                <span class="status-indicator status-offline"></span> unpre.co.kr
                            </div>
                            <div class="col-md-3">
                                <span class="status-indicator status-offline"></span> untab.co.kr
                            </div>
                            <div class="col-md-3">
                                <span class="status-indicator status-offline"></span> skewese.com
                            </div>
                            <div class="col-md-3">
                                <span class="status-indicator status-offline"></span> Database
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> 일별 발행 현황</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> 사이트별 통계</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="siteChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Posts & Schedule -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> 최근 포스트</h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="recent-posts"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-calendar-week"></i> 자동 발행 계획 (새벽 3시 실행)</h5>
                        <div>
                            <button class="btn btn-sm btn-info" onclick="showScheduleOverview()">
                                <i class="bi bi-eye"></i> 전체 계획 보기
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="triggerManualPublish()">
                                <i class="bi bi-lightning"></i> 수동 발행
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div class="mb-3 text-center">
                            <div class="auto-schedule-info bg-light p-3 rounded">
                                <h6 class="mb-1"><i class="bi bi-clock"></i> 자동 발행 시간</h6>
                                <div class="text-primary fw-bold">매일 새벽 3:00</div>
                                <small class="text-muted">3개 사이트 동시 발행</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">주차 선택:</label>
                            <input type="date" id="schedule-week-picker" class="form-control form-control-sm" 
                                   onchange="loadWeeklySchedule()">
                        </div>
                        <div id="weekly-schedule-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Management -->
        <div class="row mb-4">
            <!-- WordPress Files -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="form-check-input select-all-checkbox me-2" 
                                   id="select-all-wordpress" onchange="toggleSelectAll('wordpress')">
                            <h5 class="mb-0"><i class="bi bi-wordpress"></i> WordPress 콘텐츠</h5>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-plus-circle"></i> 새 콘텐츠
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="showWordPressModal('unpre')">unpre 콘텐츠 생성</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showWordPressModal('untab')">untab 콘텐츠 생성</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showWordPressModal('skewese')">skewese 콘텐츠 생성</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- WordPress 선택삭제 액션 바 -->
                    <div id="wordpress-bulk-actions" class="bulk-actions">
                        <div class="bulk-info">
                            <div class="bulk-count" id="wordpress-selected-count">0개 선택됨</div>
                            <span>선택된 WordPress 콘텐츠를 관리하세요</span>
                        </div>
                        <div>
                            <button class="btn btn-light btn-sm me-2" onclick="deselectAll('wordpress')">
                                <i class="bi bi-x"></i> 선택 해제
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="bulkDelete('wordpress')">
                                <i class="bi bi-trash"></i> 선택 삭제
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="wordpress-files"></div>
                    </div>
                </div>
            </div>
            
            <!-- Tistory Files -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="form-check-input select-all-checkbox me-2" 
                                   id="select-all-tistory" onchange="toggleSelectAll('tistory')">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Tistory 콘텐츠</h5>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="showTistoryModal()">
                            <i class="bi bi-plus-circle"></i> 새 콘텐츠 생성
                        </button>
                    </div>
                    
                    <!-- Tistory 선택삭제 액션 바 -->
                    <div id="tistory-bulk-actions" class="bulk-actions">
                        <div class="bulk-info">
                            <div class="bulk-count" id="tistory-selected-count">0개 선택됨</div>
                            <span>선택된 Tistory 콘텐츠를 관리하세요</span>
                        </div>
                        <div>
                            <button class="btn btn-light btn-sm me-2" onclick="deselectAll('tistory')">
                                <i class="bi bi-x"></i> 선택 해제
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="bulkDelete('tistory')">
                                <i class="bi bi-trash"></i> 선택 삭제
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="tistory-files"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topic Pool Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-collection"></i> 주제 풀 상태</h5>
                    </div>
                    <div class="card-body">
                        <div id="topic-stats" class="row"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 전체 스케줄 보기 모달 -->
    <div class="modal fade" id="scheduleOverviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar3"></i> 자동 발행 계획 전체보기
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="bi bi-info-circle"></i> 자동 발행 시스템</h6>
                                <ul class="mb-0">
                                    <li>매일 새벽 3시 자동 실행</li>
                                    <li>3개 사이트 (unpre, untab, skewese) 동시 발행</li>
                                    <li>고품질 Pexels 이미지 자동 생성</li>
                                    <li>주제별 다양한 콘텐츠 자동 생성</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="auto-schedule-next bg-light p-3 rounded">
                                <h6><i class="bi bi-clock-history"></i> 다음 실행 예정</h6>
                                <div id="next-run-time" class="fw-bold text-primary">계산 중...</div>
                                <small class="text-muted">자동으로 콘텐츠가 생성됩니다</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-overview-controls mb-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary active" onclick="showScheduleWeek('current')">이번 주</button>
                            <button class="btn btn-outline-primary" onclick="showScheduleWeek('next')">다음 주</button>
                        </div>
                    </div>
                    
                    <div id="schedule-overview-content">
                        <!-- 스케줄 내용이 여기에 표시됩니다 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script>
        // 차트 변수
        let dailyChart = null;
        let siteChart = null;

        // 시간 업데이트
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').innerText = now.toLocaleString('ko-KR');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // 데이터 새로고침
        async function refreshData() {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = 'block';
            }
            
            try {
                // 통계 데이터
                const statsRes = await fetch('/api/stats');
                const stats = await statsRes.json();
                
                document.getElementById('total-posts').innerText = stats.total_posts;
                document.getElementById('today-posts').innerText = stats.today_posts;
                document.getElementById('total-views').innerText = (stats.revenue?.total_views || 0).toLocaleString();
                document.getElementById('total-revenue').innerText = '₩' + ((stats.revenue?.total_revenue || 0) * 1400).toLocaleString();
                
                // 주제 풀 상태 가져오기
                const topicRes = await fetch('/api/topic_stats');
                const topicStats = await topicRes.json();
                updateTopicStats(topicStats);
                
                // 시스템 상태
                const statusRes = await fetch('/api/system_status');
                const status = await statusRes.json();
                updateSystemStatus(status);
                
                // 최근 포스트
                const postsRes = await fetch('/api/recent_posts');
                const posts = await postsRes.json();
                updateRecentPosts(posts);
                
                // 발행 일정
                const scheduleRes = await fetch('/api/schedule');
                if (scheduleRes.ok) {
                    const schedule = await scheduleRes.json();
                    updateSchedule(schedule);
                } else {
                    console.warn('발행 일정 데이터 로드 실패');
                }
                
                // WordPress 파일
                const wordpressRes = await fetch('/api/wordpress_files');
                const wordpressFiles = await wordpressRes.json();
                updateWordPressFiles(wordpressFiles);
                
                // Tistory 파일
                const tistoryRes = await fetch('/api/tistory_files');
                const tistoryFiles = await tistoryRes.json();
                updateTistoryFiles(tistoryFiles);
                
                // 차트 업데이트
                await updateCharts();
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                // 오류 발생시에도 로더는 숨기기
            } finally {
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.style.display = 'none';
                }
            }
        }

        // 시스템 상태 업데이트
        function updateSystemStatus(status) {
            let html = '';
            
            try {
                // API 응답 구조 확인
                if (!status || typeof status !== 'object') {
                    console.warn('Invalid status object:', status);
                    status = {
                        sites: { unpre: {status: 'offline'}, untab: {status: 'offline'}, skewese: {status: 'offline'} },
                        database: {status: 'offline'},
                        api: { openai: {status: 'offline'}, claude: {status: 'offline'} }
                    };
                }
                
                // 사이트 상태
                if (status.sites && typeof status.sites === 'object') {
                    for (const [site, info] of Object.entries(status.sites)) {
                        const isOnline = info && info.status === 'online';
                        const statusClass = isOnline ? 'status-online' : 'status-offline';
                        const statusText = isOnline ? '정상' : '오프라인';
                        html += `
                            <div class="col-md-3 mb-2">
                                <span class="status-indicator ${statusClass}"></span>
                                ${site}.co.kr <small class="text-muted">(${statusText})</small>
                            </div>
                        `;
                    }
                }
                
                // 데이터베이스
                const dbStatus = status.database && status.database.status;
                const dbClass = dbStatus === 'online' ? 'status-online' : 'status-offline';
                const dbText = dbStatus === 'online' ? '정상' : '오프라인';
                html += `
                    <div class="col-md-3 mb-2">
                        <span class="status-indicator ${dbClass}"></span>
                        Database <small class="text-muted">(${dbText})</small>
                    </div>
                `;
                
                // API 상태
                if (status.api && typeof status.api === 'object') {
                    for (const [api, info] of Object.entries(status.api)) {
                        const isOnline = info && info.status === 'online';
                        const statusClass = isOnline ? 'status-online' : 'status-offline';
                        const statusText = isOnline ? '정상' : '오프라인';
                        html += `
                            <div class="col-md-3 mb-2">
                                <span class="status-indicator ${statusClass}"></span>
                                ${api.toUpperCase()} API <small class="text-muted">(${statusText})</small>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error updating system status:', error);
                html = `
                    <div class="col-12">
                        <span class="status-indicator status-offline"></span>
                        시스템 상태 로딩 실패
                    </div>
                `;
            }
            
            const statusElement = document.getElementById('system-status');
            if (statusElement) {
                statusElement.innerHTML = html;
            }
        }

        // 최근 포스트 업데이트
        function updateRecentPosts(posts) {
            let html = '';
            
            posts.forEach(post => {
                const siteClass = `site-${post.site}`;
                const date = new Date(post.published_date).toLocaleDateString('ko-KR');
                
                html += `
                    <div class="log-entry">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="site-badge ${siteClass}">${post.site}</span>
                                <strong>${post.title}</strong>
                                <div class="text-muted small mt-1">
                                    <i class="bi bi-calendar"></i> ${date}
                                    <span class="ms-2"><i class="bi bi-folder"></i> ${post.category}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const recentPostsElement = document.getElementById('recent-posts');
            if (recentPostsElement) {
                recentPostsElement.innerHTML = html || '<p class="text-muted">포스트가 없습니다.</p>';
            }
        }

        // 발행 일정 업데이트
        function updateSchedule(schedule) {
            let html = '';
            
            if (!schedule || !Array.isArray(schedule)) {
                const scheduleElement = document.getElementById('weekly-schedule-content');
                if (scheduleElement) {
                    scheduleElement.innerHTML = '<p class="text-muted">일정 데이터를 불러올 수 없습니다.</p>';
                }
                return;
            }
            
            schedule.forEach(item => {
                if (!item || !item.site) return;
                
                const siteClass = `site-${item.site}`;
                const daysKor = (item.days && Array.isArray(item.days)) ? item.days.map(d => {
                    const dayMap = {mon: '월', tue: '화', wed: '수', thu: '목', fri: '금', sat: '토', sun: '일'};
                    return dayMap[d] || d;
                }).join(', ') : '일정 없음';
                
                html += `
                    <div class="schedule-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="site-badge ${siteClass}">${item.site}</span>
                                <strong class="ms-2">${item.time}</strong>
                            </div>
                            <span class="text-muted">${daysKor}</span>
                        </div>
                    </div>
                `;
            });
            
            const scheduleElement = document.getElementById('weekly-schedule-content');
            if (scheduleElement) {
                scheduleElement.innerHTML = html;
            }
        }

        // WordPress 파일 업데이트
        function updateWordPressFiles(files) {
            let html = '';
            
            if (!files || files.length === 0) {
                html = '<p class="text-muted">생성된 파일이 없습니다.</p>';
            } else {
                files.forEach(file => {
                    const site = file.site || 'unknown';
                    const siteClass = `site-${site}`;
                    const title = file.title || '제목 없음';
                    const date = file.date || new Date().toLocaleString();
                    const size = file.size || '0KB';
                    const status = file.status || 'draft';
                    const actions = file.actions || ['view', 'edit', 'download', 'delete'];
                    
                    // 상태별 배지 색상
                    const statusBadge = status === 'published' ? 
                        '<span class="badge bg-success">발행됨</span>' : 
                        '<span class="badge bg-warning">임시저장</span>';
                    
                    // 액션 버튼들 생성
                    let actionButtons = '';
                    
                    if (actions.includes('view') && file.url) {
                        actionButtons += `<a href="${file.url}" target="_blank" class="btn btn-outline-info btn-sm me-1" title="보기">
                            <i class="bi bi-eye"></i> 보기
                        </a>`;
                    }
                    
                    if (actions.includes('edit')) {
                        actionButtons += `<button class="btn btn-outline-primary btn-sm me-1" onclick="editContent('${file.id}', 'wordpress')" title="편집">
                            <i class="bi bi-pencil"></i> 편집
                        </button>`;
                    }
                    
                    if (actions.includes('publish') && status === 'draft') {
                        actionButtons += `<button class="btn btn-outline-success btn-sm me-1" onclick="publishContent('${file.id}', '${site}', this)" title="발행">
                            <i class="bi bi-upload"></i> 발행
                        </button>`;
                    }
                    
                    if (actions.includes('download')) {
                        actionButtons += `<button class="btn btn-outline-secondary btn-sm me-1" onclick="downloadContent('${file.id}', 'wordpress')" title="다운로드">
                            <i class="bi bi-download"></i> 다운로드
                        </button>`;
                    }
                    
                    if (actions.includes('delete')) {
                        actionButtons += `<button class="btn btn-outline-danger btn-sm" onclick="deleteContent('${file.id}', 'wordpress')" title="삭제">
                            <i class="bi bi-trash"></i> 삭제
                        </button>`;
                    }
                    
                    html += `
                        <div class="content-item mb-3 p-3 border rounded" data-file-id="${file.id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-start flex-grow-1">
                                    <input type="checkbox" class="form-check-input content-checkbox me-3" 
                                           onchange="toggleItemSelection('wordpress', '${file.id}')" data-file-id="${file.id}">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="site-badge ${siteClass}">${site.toUpperCase()}</span>
                                            ${statusBadge}
                                        </div>
                                        <h6 class="mb-1">${title}</h6>
                                        <div class="text-muted small">
                                            <i class="bi bi-calendar"></i> ${date}
                                            <span class="ms-3"><i class="bi bi-file-text"></i> ${size}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group-sm">
                                    ${actionButtons}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const wordpressElement = document.getElementById('wordpress-files');
            if (wordpressElement) {
                wordpressElement.innerHTML = html || '<p class="text-muted">생성된 파일이 없습니다.</p>';
            }
        }

        // Tistory 파일 업데이트
        function updateTistoryFiles(files) {
            let html = '';
            
            if (!files || files.length === 0) {
                html = '<p class="text-muted">생성된 파일이 없습니다.</p>';
            } else {
                files.forEach(file => {
                    const title = file.title || '제목 없음';
                    const date = file.date || new Date().toLocaleString();
                    const size = file.size || '0KB';
                    const status = file.status || 'draft';
                    const category = file.category || '카테고리 없음';
                    const tags = file.tags || [];
                    const actions = file.actions || ['view', 'download', 'delete'];
                    
                    // 상태별 배지 색상
                    const statusBadge = status === 'published' ? 
                        '<span class="badge bg-success">발행됨</span>' : 
                        '<span class="badge bg-warning">임시저장</span>';
                    
                    // 태그 표시
                    const tagHtml = tags.slice(0, 3).map(tag => 
                        `<span class="badge bg-secondary me-1">${tag}</span>`
                    ).join('');
                    
                    // 액션 버튼들 생성
                    let actionButtons = '';
                    
                    if (actions.includes('view') && file.url) {
                        actionButtons += `<a href="${file.url}" target="_blank" class="btn btn-outline-info btn-sm me-1" title="보기">
                            <i class="bi bi-eye"></i> 보기
                        </a>`;
                    }
                    
                    if (actions.includes('edit')) {
                        actionButtons += `<button class="btn btn-outline-primary btn-sm me-1" onclick="editContent('${file.id}', 'tistory')" title="편집">
                            <i class="bi bi-pencil"></i> 편집
                        </button>`;
                    }
                    
                    if (actions.includes('publish') && status === 'draft') {
                        actionButtons += `<button class="btn btn-outline-success btn-sm me-1" onclick="publishToTistory('${file.id}', this)" title="발행">
                            <i class="bi bi-upload"></i> 발행
                        </button>`;
                    }
                    
                    if (actions.includes('download')) {
                        actionButtons += `<button class="btn btn-outline-secondary btn-sm me-1" onclick="downloadContent('${file.id}', 'tistory')" title="다운로드">
                            <i class="bi bi-download"></i> 다운로드
                        </button>`;
                    }
                    
                    if (actions.includes('delete')) {
                        actionButtons += `<button class="btn btn-outline-danger btn-sm" onclick="deleteContent('${file.id}', 'tistory')" title="삭제">
                            <i class="bi bi-trash"></i> 삭제
                        </button>`;
                    }
                    
                    html += `
                        <div class="content-item mb-3 p-3 border rounded" data-file-id="${file.id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-start flex-grow-1">
                                    <input type="checkbox" class="form-check-input content-checkbox me-3" 
                                           onchange="toggleItemSelection('tistory', '${file.id}')" data-file-id="${file.id}">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-info me-2">TISTORY</span>
                                            <span class="badge bg-secondary me-2">${category}</span>
                                            ${statusBadge}
                                        </div>
                                        <h6 class="mb-1">${title}</h6>
                                        ${tagHtml ? `<div class="mb-2">${tagHtml}</div>` : ''}
                                        <div class="text-muted small">
                                            <i class="bi bi-calendar"></i> ${date}
                                            <span class="ms-3"><i class="bi bi-file-text"></i> ${size}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group-sm">
                                    ${actionButtons}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const tistoryElement = document.getElementById('tistory-files');
            if (tistoryElement) {
                tistoryElement.innerHTML = html;
            }
        }

        // 주제 풀 상태 업데이트
        function updateTopicStats(topicStats) {
            let html = '';
            
            if (!topicStats || typeof topicStats !== 'object') {
                html = '<div class="col-12"><p class="text-muted">주제 풀 데이터를 불러오는 중...</p></div>';
            } else {
                for (const [site, stats] of Object.entries(topicStats)) {
                    if (!stats || typeof stats !== 'object') continue;
                    
                    const total = (stats.total || 0);
                    const used = (stats.used || 0);
                    const available = (stats.available || 0);
                    const percentage = total > 0 ? Math.round((used / total) * 100) : 0;
                    
                    html += `
                        <div class="col-md-4 mb-3">
                            <h6 class="text-uppercase">${site}</h6>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-success" style="width: ${percentage}%">
                                    사용: ${used}
                                </div>
                                <div class="progress-bar bg-info" style="width: ${100-percentage}%">
                                    가능: ${available}
                                </div>
                            </div>
                            <small class="text-muted">총 ${total}개 중 ${used}개 사용</small>
                        </div>
                    `;
                }
            }
            
            const topicStatsElement = document.getElementById('topic-stats');
            if (topicStatsElement) {
                topicStatsElement.innerHTML = html;
            }
        }

        // 차트 업데이트
        async function updateCharts() {
            try {
                // 일별 차트 데이터 API 호출
                const dailyRes = await fetch('/api/chart/daily');
                if (!dailyRes.ok) {
                    throw new Error(`HTTP ${dailyRes.status}`);
                }
                const dailyData = await dailyRes.json();
            
                // 일별 차트 데이터 준비
                const dailyLabels = dailyData.labels || [];
                const dailyValues = dailyData.data || [];
                
                const ctx1 = document.getElementById('dailyChart').getContext('2d');
                if (dailyChart) dailyChart.destroy();
                
                dailyChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: '발행 포스트',
                            data: dailyValues,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
                
                // 사이트별 차트 데이터 API 호출
                const siteRes = await fetch('/api/chart/site');
                if (!siteRes.ok) {
                    throw new Error(`HTTP ${siteRes.status}`);
                }
                const siteData = await siteRes.json();
                
                // 사이트별 차트 데이터 준비
                const siteLabels = siteData.labels || [];
                const siteValues = siteData.data || [];
                
                const ctx2 = document.getElementById('siteChart').getContext('2d');
                if (siteChart) siteChart.destroy();
                
                siteChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: siteLabels,
                        datasets: [{
                            data: siteValues,
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(72, 199, 116, 0.8)',
                                'rgba(255, 183, 77, 0.8)',
                                'rgba(255, 107, 107, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } catch (error) {
                console.error('차트 업데이트 오류:', error);
            }
        }

        // WordPress 콘텐츠 생성
        async function generateWordPressContent() {
            // 모달에서 입력값 가져오기
            const site = selectedWpSite;
            const topic = document.getElementById('wpContentTopic').value.trim();
            const keywordsInput = document.getElementById('wpContentKeywords').value.trim();
            const contentLength = document.getElementById('wpContentLength').value;
            let category = document.getElementById('wpContentCategory').value;
            
            if (!topic) {
                showNotification('주제를 입력해주세요.', 'error');
                return;
            }
            
            // 직접입력 카테고리 처리
            if (category === '직접입력') {
                const customCategory = document.getElementById('wpCustomCategory').value.trim();
                if (!customCategory) {
                    showNotification('직접입력 카테고리를 입력해주세요.', 'error');
                    return;
                }
                category = customCategory;
            }
            
            // 키워드 처리 (콤마로 분리)
            const keywords = keywordsInput ? 
                keywordsInput.split(',').map(k => k.trim()).filter(k => k.length > 0) : 
                getDefaultKeywordsByCategory(category);
            
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('wordpressModal'));
            modal.hide();
            
            // 진행 상황 상세 표시
            showNotification(`🚀 ${site.toUpperCase()} 콘텐츠 생성 시작...`, 'info');
            showProgressSteps([
                '✨ AI가 콘텐츠를 작성하고 있습니다...',
                '🔍 SEO 최적화 진행 중...',
                '📝 파일 저장 중...',
                '💾 데이터베이스 등록 중...'
            ]);
            
            try {
                console.log('Sending WordPress generation request...');
                const res = await fetch('/api/generate_wordpress', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        site: site, 
                        topic: topic,
                        keywords: keywords,
                        category: category,
                        content_length: contentLength
                    })
                });
                
                console.log('Response received, status:', res.status);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const result = await res.json();
                console.log('Generation result:', result);
                hideProgressSteps();
                
                if (result.success) {
                    showNotification(`✅ ${site.toUpperCase()} 콘텐츠 생성 완료!`, 'success');
                    
                    // 업데이트 중 표시 (새로운 디자인)
                    const wpFilesContainer = document.getElementById('wordpress-files');
                    wpFilesContainer.insertAdjacentHTML('afterbegin', 
                        `<div id="updating-indicator" class="update-indicator">
                            <div class="spinner"></div>
                            목록을 업데이트하고 있습니다...
                            <small style="display: block; margin-top: 5px; opacity: 0.8;">
                                새로 생성된 콘텐츠를 불러오는 중 (최대 5초)
                            </small>
                        </div>`
                    );
                    
                    // 즉시 목록에 새 콘텐츠 표시 (임시)
                    addTemporaryContent('wordpress', {
                        title: result.title || topic,
                        site: site,
                        category: category,
                        keywords: keywords.slice(0, 3),
                        created_at: new Date().toISOString(),
                        isNew: true
                    });
                    
                    // 여러 번 시도해서 목록 갱신 보장
                    let retryCount = 0;
                    const maxRetries = 5;
                    
                    const updateList = async () => {
                        try {
                            const wordpressRes = await fetch('/api/wordpress_files');
                            const wordpressFiles = await wordpressRes.json();
                            
                            // 새로 생성된 콘텐츠가 목록에 있는지 확인
                            const resultTitle = result.title || result.post?.title || topic;
                            const hasNewContent = wordpressFiles.some(f => 
                                (f.title && resultTitle && f.title.includes(resultTitle.substring(0, 10))) ||
                                (f.id && result.id && f.id === result.id) ||
                                new Date(f.created_at).getTime() > Date.now() - 60000 // 1분 이내 생성
                            );
                            
                            updateWordPressFiles(wordpressFiles);
                            
                            if (hasNewContent || retryCount >= maxRetries) {
                                // 업데이트 중 인디케이터 제거
                                const indicator = document.getElementById('updating-indicator');
                                if (indicator) indicator.remove();
                                
                                showNotification(`🎉 목록이 업데이트되었습니다! 새 콘텐츠를 확인하세요.`, 'info');
                                // 전체 데이터도 갱신
                                refreshData();
                            } else {
                                retryCount++;
                                setTimeout(updateList, 1000); // 1초 후 재시도
                            }
                        } catch (error) {
                            if (retryCount < maxRetries) {
                                retryCount++;
                                setTimeout(updateList, 1000);
                            } else {
                                // 업데이트 중 인디케이터 제거
                                const indicator = document.getElementById('updating-indicator');
                                if (indicator) indicator.remove();
                                
                                showNotification('목록 갱신 중 오류가 발생했습니다. 페이지를 새로고침해주세요.', 'error');
                            }
                        }
                    };
                    
                    // 즉시 첫 번째 갱신 시도
                    setTimeout(updateList, 500);
                    
                    // 폼 리셋
                    document.getElementById('wordpressForm').reset();
                } else {
                    showNotification(`❌ 생성 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                hideProgressSteps();
                showNotification(`❌ 오류: ${error.message}`, 'error');
            }
        }
        
        // 카테고리별 기본 키워드 반환
        function getDefaultKeywordsByCategory(category) {
            const defaultKeywords = {
                '프로그래밍': ['프로그래밍', '코딩', '개발', '알고리즘', '자료구조'],
                '웹개발': ['웹개발', 'HTML', 'CSS', 'JavaScript', '프론트엔드'],
                '데이터사이언스': ['데이터분석', 'Python', '머신러닝', '통계', '빅데이터'],
                'AI/ML': ['인공지능', '머신러닝', '딥러닝', 'AI', '신경망'],
                'DevOps': ['DevOps', '배포', 'CI/CD', 'Docker', 'Kubernetes'],
                '모바일개발': ['모바일', '앱개발', 'React Native', 'Flutter', 'iOS'],
                '게임개발': ['게임개발', 'Unity', '게임엔진', '3D', '게임디자인'],
                '기타': ['개발', '프로그래밍', '기술', 'IT', '소프트웨어']
            };
            return defaultKeywords[category] || defaultKeywords['기타'];
        }

        // WordPress 발행
        async function publishToWordPress(fileId, site) {
            if (!confirm(`${site}에 이 콘텐츠를 발행하시겠습니까?`)) return;
            
            showNotification('발행 중...', 'info');
            
            try {
                const res = await fetch('/api/publish_to_wordpress', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({file_id: fileId, site: site})
                });
                
                const result = await res.json();
                
                if (result.success) {
                    showNotification('발행 완료!', 'success');
                    refreshData();
                } else {
                    showNotification(`발행 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`오류: ${error.message}`, 'error');
            }
        }

        // 파일 삭제
        async function deleteFile(fileId) {
            if (!confirm('이 파일을 삭제하시겠습니까?')) return;
            
            console.log('Deleting file with ID:', fileId);
            showNotification('파일 삭제 중...', 'info');
            
            try {
                const response = await fetch('/api/delete_file', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({file_id: fileId})
                });
                
                console.log('Delete response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete failed with status:', response.status, 'Error:', errorText);
                    showNotification(`삭제 실패 (${response.status}): ${errorText}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('Delete result:', result);
                
                if (result.success) {
                    showNotification('파일이 성공적으로 삭제되었습니다.', 'success');
                    await refreshData(); // 데이터 새로고침 대기
                } else {
                    showNotification(`삭제 실패: ${result.error || '알 수 없는 오류'}`, 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification(`네트워크 오류: ${error.message}`, 'error');
            }
        }

        // Tistory 콘텐츠 생성
        async function generateTistoryContent() {
            // 모달에서 입력값 가져오기
            const topic = document.getElementById('contentTopic').value.trim();
            const keywordsInput = document.getElementById('contentKeywords').value.trim();
            const contentLength = document.getElementById('contentLength').value;
            const category = document.getElementById('contentCategory').value;
            
            if (!topic) {
                showNotification('주제를 입력해주세요.', 'error');
                return;
            }
            
            // 키워드 처리 (콤마로 분리)
            const keywords = keywordsInput ? 
                keywordsInput.split(',').map(k => k.trim()).filter(k => k.length > 0) : 
                ['토익', '영어학습', '어학시험', '고득점', '학습법'];
            
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('tistoryModal'));
            modal.hide();
            
            // Tistory 진행 상황 표시
            showNotification('🚀 Tistory 콘텐츠 생성 시작...', 'info');
            showProgressSteps([
                '✨ AI가 Tistory 콘텐츠를 작성하고 있습니다...',
                '🎨 HTML 형식으로 변환 중...',
                '📝 파일 저장 중...',
                '💾 데이터베이스 등록 중...'
            ]);
            
            try {
                const res = await fetch('/api/generate_tistory', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic: topic,
                        keywords: keywords,
                        category: category,
                        content_length: contentLength
                    })
                });
                
                const result = await res.json();
                hideProgressSteps();
                
                if (result.success) {
                    showNotification(`✅ Tistory 콘텐츠 생성 완료!`, 'success');
                    
                    // 업데이트 중 표시
                    const tistoryFilesContainer = document.getElementById('tistory-files');
                    tistoryFilesContainer.insertAdjacentHTML('afterbegin', 
                        `<div id="tistory-updating-indicator" class="update-indicator">
                            <div class="spinner"></div>
                            목록을 업데이트하고 있습니다...
                            <small style="display: block; margin-top: 5px; opacity: 0.8;">
                                새로 생성된 콘텐츠를 불러오는 중 (최대 5초)
                            </small>
                        </div>`
                    );
                    
                    // 즉시 목록에 새 콘텐츠 표시 (임시)
                    addTemporaryContent('tistory', {
                        title: result.title || topic,
                        category: category,
                        keywords: keywords.slice(0, 3),
                        created_at: new Date().toISOString(),
                        isNew: true
                    });
                    
                    // 여러 번 시도해서 목록 갱신 보장
                    let retryCount = 0;
                    const maxRetries = 5;
                    
                    const updateList = async () => {
                        try {
                            const tistoryRes = await fetch('/api/tistory_files');
                            const tistoryFiles = await tistoryRes.json();
                            
                            // 새로 생성된 콘텐츠가 목록에 있는지 확인
                            const resultTitle = result.title || result.post?.title || topic;
                            const hasNewContent = tistoryFiles.some(f => 
                                (f.title && resultTitle && f.title.includes(resultTitle.substring(0, 10))) ||
                                (f.id && result.id && f.id === result.id) ||
                                new Date(f.created_at).getTime() > Date.now() - 60000 // 1분 이내 생성
                            );
                            
                            updateTistoryFiles(tistoryFiles);
                            
                            if (hasNewContent || retryCount >= maxRetries) {
                                // 업데이트 중 인디케이터 제거
                                const indicator = document.getElementById('tistory-updating-indicator');
                                if (indicator) indicator.remove();
                                
                                showNotification(`🎉 목록이 업데이트되었습니다! 새 콘텐츠를 확인하세요.`, 'info');
                                // 전체 데이터도 갱신
                                refreshData();
                            } else {
                                retryCount++;
                                setTimeout(updateList, 1000); // 1초 후 재시도
                            }
                        } catch (error) {
                            if (retryCount < maxRetries) {
                                retryCount++;
                                setTimeout(updateList, 1000);
                            } else {
                                // 업데이트 중 인디케이터 제거
                                const indicator = document.getElementById('tistory-updating-indicator');
                                if (indicator) indicator.remove();
                                
                                showNotification('목록 갱신 중 오류가 발생했습니다. 페이지를 새로고침해주세요.', 'error');
                            }
                        }
                    };
                    
                    // 즉시 첫 번째 갱신 시도
                    setTimeout(updateList, 500);
                    
                    // 폼 리셋
                    document.getElementById('tistoryForm').reset();
                } else {
                    if (result.error && result.error.includes('API key')) {
                        showNotification(`❌ Claude API 키 설정이 필요합니다!\n\n1. https://console.anthropic.com 에서 API 키 발급\n2. .env 파일의 ANTHROPIC_API_KEY 설정\n3. 서버 재시작\n\n오류: ${result.error}`, 'error');
                    } else {
                        showNotification(`❌ 생성 실패: ${result.error}`, 'error');
                    }
                }
            } catch (error) {
                hideProgressSteps();
                showNotification(`❌ 오류: ${error.message}`, 'error');
            }
        }

        // 알림 표시
        function showNotification(message, type = 'info') {
            // 기존 알림 제거
            const existing = document.querySelector('.notification-toast');
            if (existing) existing.remove();
            
            const colors = {
                success: '#28a745',
                error: '#dc3545', 
                info: '#17a2b8',
                warning: '#ffc107'
            };
            
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999;
                max-width: 300px;
                font-weight: 500;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 조용한 새로고침 (로딩 스피너 없이)
        async function refreshDataQuietly() {
            try {
                // 통계 데이터
                const statsRes = await fetch('/api/stats');
                const stats = await statsRes.json();
                
                document.getElementById('total-posts').innerText = stats.total_posts;
                document.getElementById('today-posts').innerText = stats.today_posts;
                document.getElementById('total-views').innerText = (stats.revenue?.total_views || 0).toLocaleString();
                document.getElementById('total-revenue').innerText = '₩' + ((stats.revenue?.total_revenue || 0) * 1400).toLocaleString();
                
                // WordPress 파일 (가장 중요한 데이터만)
                const wordpressRes = await fetch('/api/wordpress_files');
                const wordpressFiles = await wordpressRes.json();
                updateWordPressFiles(wordpressFiles);
                
                // Tistory 파일
                const tistoryRes = await fetch('/api/tistory_files');
                const tistoryFiles = await tistoryRes.json();
                updateTistoryFiles(tistoryFiles);
                
            } catch (error) {
                console.log('조용한 새로고침 실패:', error);
            }
        }

        // 초기 로드
        refreshData();
        
        // 2분마다 자동 새로고침 (조용한 업데이트)
        setInterval(() => {
            refreshDataQuietly();
        }, 120000);
    </script>

    <!-- Tistory 콘텐츠 생성 모달 -->
    <div class="modal fade" id="tistoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-text"></i> Tistory 콘텐츠 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tistoryForm">
                        <div class="mb-3">
                            <label for="contentTopic" class="form-label">콘텐츠 주제 *</label>
                            <input type="text" class="form-control" id="contentTopic" 
                                   placeholder="예: 토익 900점 달성 전략" required>
                            <div class="form-text">생성할 콘텐츠의 주요 주제를 입력하세요</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contentKeywords" class="form-label">필수 키워드</label>
                            <input type="text" class="form-control" id="contentKeywords" 
                                   placeholder="예: 토익, 영어학습, 고득점, 시험준비">
                            <div class="form-text">콤마(,)로 구분하여 입력 (최대 10개)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contentLength" class="form-label">콘텐츠 길이</label>
                            <select class="form-select" id="contentLength">
                                <option value="short">짧음 (1,500-2,000자)</option>
                                <option value="medium" selected>보통 (2,500-3,500자)</option>
                                <option value="long">길게 (4,000-5,500자)</option>
                                <option value="very_long">매우 길게 (6,000-8,000자)</option>
                            </select>
                            <div class="form-text">콘텐츠의 길이를 선택하세요</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contentCategory" class="form-label">카테고리</label>
                            <select class="form-select" id="contentCategory">
                                <option value="언어학습">언어학습</option>
                                <option value="자격증">자격증</option>
                                <option value="취업">취업</option>
                                <option value="여행">여행</option>
                                <option value="라이프스타일">라이프스타일</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="generateTistoryContent()">
                        <i class="bi bi-magic"></i> 콘텐츠 생성
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- WordPress 콘텐츠 생성 모달 -->
    <div class="modal fade" id="wordpressModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-wordpress"></i> <span id="wpSiteName">WordPress</span> 콘텐츠 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="wordpressForm">
                        <div class="mb-3">
                            <label for="wpSite" class="form-label">사이트 선택</label>
                            <input type="text" class="form-control" id="wpSite" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="wpContentTopic" class="form-label">콘텐츠 주제 *</label>
                            <input type="text" class="form-control" id="wpContentTopic" 
                                   placeholder="예: React 프로그래밍 완전정복" required>
                            <div class="form-text">생성할 콘텐츠의 주요 주제를 입력하세요</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="wpContentKeywords" class="form-label">필수 키워드</label>
                            <input type="text" class="form-control" id="wpContentKeywords" 
                                   placeholder="예: React, JavaScript, 프론트엔드, 웹개발">
                            <div class="form-text">콤마(,)로 구분하여 입력 (최대 10개)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="wpContentLength" class="form-label">콘텐츠 길이</label>
                            <select class="form-select" id="wpContentLength">
                                <option value="short">짧음 (1,500-2,000자)</option>
                                <option value="medium" selected>보통 (2,500-3,500자)</option>
                                <option value="long">길게 (4,000-5,500자)</option>
                                <option value="very_long">매우 길게 (6,000-8,000자)</option>
                            </select>
                            <div class="form-text">콘텐츠의 길이를 선택하세요</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="wpContentCategory" class="form-label">카테고리</label>
                            <select class="form-select" id="wpContentCategory" onchange="toggleCustomCategory()">
                                <!-- 사이트별 카테고리가 JavaScript로 동적 생성됩니다 -->
                            </select>
                        </div>
                        
                        <div class="mb-3" id="customCategoryDiv" style="display: none;">
                            <label for="wpCustomCategory" class="form-label">직접 입력 카테고리</label>
                            <input type="text" class="form-control" id="wpCustomCategory" 
                                   placeholder="카테고리를 직접 입력하세요">
                            <div class="form-text">직접 카테고리를 입력할 수 있습니다</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="generateWordPressContent()">
                        <i class="bi bi-magic"></i> 콘텐츠 생성
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WordPress 모달 표시
        let selectedWpSite = '';
        
        // 사이트별 카테고리 정의
        const siteCategories = {
            'unpre': [
                '개발', 'IT', '프로그래밍', 'JavaScript', 'Python', 'React', 'Node.js',
                '데이터베이스', '웹개발', 'DevOps', 'AI/ML', '정보처리기사', '언어학습',
                '토익', 'JLPT', '영어회화', '직접입력'
            ],
            'untab': [
                '부동산', '경매', '공매', '정책/제도', '투자전략', '시장분석',
                '권리분석', '임대수익', '재개발', '재건축', '법률정보', '세금',
                '대출', '투자리스크', '직접입력'
            ],
            'skewese': [
                '세계사', '한국사', '고대사', '근현대사', '역사인물', '문화사',
                '전쟁사', '정치사', '사회사', '문화재', '박물관', '역사여행',
                '역사드라마', '문화유산', '직접입력'
            ]
        };
        
        function showWordPressModal(site) {
            selectedWpSite = site;
            document.getElementById('wpSite').value = site;
            document.getElementById('wpSiteName').textContent = site.toUpperCase();
            
            // 사이트별 카테고리 업데이트
            updateCategoriesForSite(site);
            
            // 커스텀 카테고리 입력창 숨기기
            document.getElementById('customCategoryDiv').style.display = 'none';
            document.getElementById('wpCustomCategory').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('wordpressModal'));
            modal.show();
        }
        
        function updateCategoriesForSite(site) {
            const categorySelect = document.getElementById('wpContentCategory');
            const categories = siteCategories[site] || ['기타', '직접입력'];
            
            // 기존 옵션 제거
            categorySelect.innerHTML = '';
            
            // 사이트별 카테고리 추가
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
        
        function toggleCustomCategory() {
            const categorySelect = document.getElementById('wpContentCategory');
            const customDiv = document.getElementById('customCategoryDiv');
            
            if (categorySelect.value === '직접입력') {
                customDiv.style.display = 'block';
                document.getElementById('wpCustomCategory').focus();
            } else {
                customDiv.style.display = 'none';
                document.getElementById('wpCustomCategory').value = '';
            }
        }
        
        // Tistory 모달 표시
        function showTistoryModal() {
            const modal = new bootstrap.Modal(document.getElementById('tistoryModal'));
            modal.show();
        }
        
        // 진행 단계 표시 (중앙 오버레이)
        function showProgressSteps(steps) {
            console.log('🎬 중앙 진행 오버레이 시작:', steps);
            
            // 기존 오버레이 제거
            const existingOverlay = document.getElementById('progress-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // 중앙 오버레이 생성
            const overlay = document.createElement('div');
            overlay.className = 'progress-overlay';
            overlay.id = 'progress-overlay';
            
            const container = document.createElement('div');
            container.className = 'progress-container';
            
            container.innerHTML = `
                <div class="progress-title">
                    <i class="bi bi-magic" style="color: #667eea; margin-right: 10px;"></i>
                    콘텐츠 생성 중
                </div>
                <ul class="progress-steps-list" id="progress-steps-list">
                    ${steps.map((step, index) => `
                        <li class="progress-step-item" id="step-${index}">
                            <div class="progress-step-icon waiting" id="icon-${index}">
                                <i class="bi bi-circle"></i>
                            </div>
                            <div class="progress-step-text" id="text-${index}">
                                ${step}
                            </div>
                        </li>
                    `).join('')}
                </ul>
                <div style="margin-top: 20px; color: #6c757d;">
                    <small>잠시만 기다려주세요...</small>
                </div>
            `;
            
            overlay.appendChild(container);
            document.body.appendChild(overlay);
            
            // 단계별 진행 애니메이션
            let currentStep = 0;
            const progressInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    // 현재 단계 활성화
                    const icon = document.getElementById(`icon-${currentStep}`);
                    const text = document.getElementById(`text-${currentStep}`);
                    
                    if (icon && text) {
                        icon.className = 'progress-step-icon active';
                        icon.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>';
                        text.className = 'progress-step-text active';
                    }
                    
                    // 이전 단계들 완료 표시
                    for (let i = 0; i < currentStep; i++) {
                        const prevIcon = document.getElementById(`icon-${i}`);
                        const prevText = document.getElementById(`text-${i}`);
                        if (prevIcon && prevText) {
                            prevIcon.className = 'progress-step-icon completed';
                            prevIcon.innerHTML = '<i class="bi bi-check-lg"></i>';
                            prevText.className = 'progress-step-text completed';
                        }
                    }
                    
                    currentStep++;
                } else {
                    // 모든 단계 완료
                    for (let i = 0; i < steps.length; i++) {
                        const icon = document.getElementById(`icon-${i}`);
                        const text = document.getElementById(`text-${i}`);
                        if (icon && text) {
                            icon.className = 'progress-step-icon completed';
                            icon.innerHTML = '<i class="bi bi-check-lg"></i>';
                            text.className = 'progress-step-text completed';
                        }
                    }
                    clearInterval(progressInterval);
                }
            }, 1200); // 1.2초마다 다음 단계
            
            window.currentProgressInterval = progressInterval;
        }
        
        function hideProgressSteps() {
            const overlay = document.getElementById('progress-overlay');
            if (overlay) {
                overlay.remove();
            }
            
            if (window.currentProgressInterval) {
                clearInterval(window.currentProgressInterval);
                window.currentProgressInterval = null;
            }
        }
        
        // 파일 삭제 기능
        async function deleteFile(fileId, type) {
            if (!confirm('이 파일을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
            
            showNotification('파일 삭제 중...', 'info');
            
            try {
                const res = await fetch('/api/delete_file', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({file_id: fileId, type: type})
                });
                
                const result = await res.json();
                
                if (result.success) {
                    showNotification('✅ 파일이 삭제되었습니다', 'success');
                    refreshData();
                } else {
                    showNotification(`❌ 삭제 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ 삭제 오류: ${error.message}`, 'error');
            }
        }
        
        // 임시로 새 콘텐츠를 목록에 추가 (즉시 피드백용)
        function addTemporaryContent(type, contentData) {
            console.log('📝 임시 콘텐츠 추가:', type, contentData);
            
            const containerId = type === 'wordpress' ? 'wordpress-files' : 'tistory-files';
            const container = document.getElementById(containerId);
            
            const dateObj = new Date(contentData.created_at);
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth() + 1;
            const day = dateObj.getDate();
            const hours = String(dateObj.getHours()).padStart(2, '0');
            const minutes = String(dateObj.getMinutes()).padStart(2, '0');
            const date = `${year}. ${month}. ${day}. ${hours}:${minutes}`;
            const siteClass = `site-${contentData.site}`;
            
            let tempHtml = '';
            if (type === 'wordpress') {
                const keywordTags = contentData.keywords.map(keyword => 
                    `<span class="badge bg-primary me-1">${keyword}</span>`
                ).join('');
                
                tempHtml = `
                    <div class="wordpress-file mb-3 p-2 border rounded bg-light" id="temp-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="site-badge ${siteClass}">${contentData.site.toUpperCase()}</span>
                                    <span class="badge bg-secondary ms-2">${contentData.category}</span>
                                    <span class="badge bg-success ms-2">새로 생성됨</span>
                                </div>
                                <strong>📝 ${contentData.title}</strong>
                                <div class="mt-2">${keywordTags}</div>
                                <div class="text-muted small mt-1">
                                    <i class="bi bi-calendar"></i> ${date} (방금 전)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const keywordTags = contentData.keywords.map(keyword => 
                    `<span class="badge bg-secondary">${keyword}</span>`
                ).join(' ');
                
                tempHtml = `
                    <div class="tistory-file mb-3 p-2 border rounded bg-light" id="temp-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-success">새로 생성됨</span>
                                </div>
                                <strong>📝 ${contentData.title}</strong>
                                <div class="mt-1">${keywordTags}</div>
                                <div class="text-muted small mt-1">
                                    <i class="bi bi-calendar"></i> ${date} (방금 전)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 기존 내용 맨 위에 추가 (즉시 보이도록)
            console.log('📌 임시 콘텐츠를 목록 맨 위에 추가');
            container.insertAdjacentHTML('afterbegin', tempHtml);
        }
        
        // 선택삭제 기능
        const selectedFiles = {
            wordpress: new Set(),
            tistory: new Set()
        };
        
        // 전체 선택/해제 토글
        function toggleSelectAll(type) {
            const selectAllCheckbox = document.getElementById(`select-all-${type}`);
            const containerId = type === 'wordpress' ? 'wordpress-files' : 'tistory-files';
            const container = document.getElementById(containerId);
            const contentCheckboxes = container.querySelectorAll('.content-checkbox[data-file-id]');
            const isChecked = selectAllCheckbox.checked;
            
            selectedFiles[type].clear();
            
            contentCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) {
                    const fileId = parseInt(checkbox.dataset.fileId);
                    selectedFiles[type].add(fileId);
                }
            });
            
            updateBulkActionBar(type);
        }
        
        // 개별 아이템 선택/해제 토글
        function toggleItemSelection(type, fileId) {
            const checkbox = document.querySelector(`.content-checkbox[data-file-id="${fileId}"]`);
            
            if (checkbox.checked) {
                selectedFiles[type].add(fileId);
            } else {
                selectedFiles[type].delete(fileId);
            }
            
            // 전체 선택 체크박스 상태 업데이트
            const selectAllCheckbox = document.getElementById(`select-all-${type}`);
            const containerId = type === 'wordpress' ? 'wordpress-files' : 'tistory-files';
            const container = document.getElementById(containerId);
            const totalCheckboxes = container.querySelectorAll('.content-checkbox[data-file-id]').length;
            const checkedCount = selectedFiles[type].size;
            
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCheckboxes;
            selectAllCheckbox.checked = checkedCount === totalCheckboxes && totalCheckboxes > 0;
            
            updateBulkActionBar(type);
        }
        
        // 벌크 액션 바 업데이트
        function updateBulkActionBar(type) {
            const bulkActions = document.getElementById(`${type}-bulk-actions`);
            const selectedCount = document.getElementById(`${type}-selected-count`);
            const count = selectedFiles[type].size;
            
            selectedCount.textContent = `${count}개 선택됨`;
            
            if (count > 0) {
                bulkActions.style.display = 'flex';
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        // 모든 선택 해제
        function deselectAll(type) {
            selectedFiles[type].clear();
            
            // 해당 타입의 모든 체크박스 해제
            const containerId = type === 'wordpress' ? 'wordpress-files' : 'tistory-files';
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('.content-checkbox[data-file-id]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // 전체 선택 체크박스 해제
            const selectAllCheckbox = document.getElementById(`select-all-${type}`);
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            
            updateBulkActionBar(type);
        }
        
        // 벌크 삭제 실행
        async function bulkDelete(type) {
            const selectedIds = Array.from(selectedFiles[type]);
            
            if (selectedIds.length === 0) {
                showNotification('삭제할 파일을 선택해주세요', 'warning');
                return;
            }
            
            const confirmMessage = `선택한 ${selectedIds.length}개의 ${type === 'wordpress' ? 'WordPress' : 'Tistory'} 파일을 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`;
            
            if (!confirm(confirmMessage)) return;
            
            showNotification(`${selectedIds.length}개 파일 삭제 중...`, 'info');
            
            try {
                const res = await fetch(`${window.location.origin}/api/bulk_delete_files`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        file_ids: selectedIds
                    })
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const result = await res.json();
                
                if (result.success) {
                    showNotification(`✅ ${result.deleted_count}개 파일이 삭제되었습니다`, 'success');
                    
                    if (result.failed_ids && result.failed_ids.length > 0) {
                        showNotification(`⚠️ ${result.failed_ids.length}개 파일 삭제 실패`, 'warning');
                    }
                    
                    // 선택 상태 초기화
                    deselectAll(type);
                    
                    // 데이터 새로고침
                    refreshData();
                } else {
                    showNotification(`❌ 삭제 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('벌크 삭제 오류:', error);
                showNotification(`❌ 삭제 오류: ${error.message}`, 'error');
            }
        }
        
        // 페이지 로드 시 체크박스 강제 추가
        document.addEventListener('DOMContentLoaded', function() {
            console.log('💡 체크박스 강제 추가 시작');
            
            // WordPress 헤더에 체크박스 추가
            setTimeout(function() {
                const wpHeader = document.querySelector('.card-header h5');
                if (wpHeader && wpHeader.textContent.includes('WordPress')) {
                    const parent = wpHeader.parentElement;
                    if (!parent.querySelector('#select-all-wordpress')) {
                        const checkboxContainer = document.createElement('div');
                        checkboxContainer.className = 'd-flex align-items-center';
                        checkboxContainer.innerHTML = `
                            <input type="checkbox" class="form-check-input select-all-checkbox me-2" 
                                   id="select-all-wordpress" onchange="toggleSelectAll('wordpress')" 
                                   style="display: block !important; visibility: visible !important; opacity: 1 !important; width: 20px; height: 20px;">
                        `;
                        parent.insertBefore(checkboxContainer.firstElementChild, wpHeader);
                        console.log('✅ WordPress 헤더 체크박스 추가됨');
                        
                        // 대량 작업 바 추가
                        addBulkActionBar('wordpress', wpHeader.closest('.card'));
                    }
                }
                
                // Tistory 헤더에 체크박스 추가
                const allCards = document.querySelectorAll('.card');
                allCards.forEach(card => {
                    const header = card.querySelector('h5');
                    if (header && header.textContent.includes('Tistory')) {
                        const parent = header.parentElement;
                        if (!parent.querySelector('#select-all-tistory')) {
                            const checkboxContainer = document.createElement('div');
                            checkboxContainer.className = 'd-flex align-items-center';
                            checkboxContainer.innerHTML = `
                                <input type="checkbox" class="form-check-input select-all-checkbox me-2" 
                                       id="select-all-tistory" onchange="toggleSelectAll('tistory')" 
                                       style="display: block !important; visibility: visible !important; opacity: 1 !important; width: 20px; height: 20px;">
                            `;
                            parent.insertBefore(checkboxContainer.firstElementChild, header);
                            console.log('✅ Tistory 헤더 체크박스 추가됨');
                            
                            // 대량 작업 바 추가
                            addBulkActionBar('tistory', header.closest('.card'));
                        }
                    }
                });
            }, 1000); // 1초 후 실행
        });
        
        // 대량 작업 바 추가
        function addBulkActionBar(type, cardElement) {
            if (cardElement.querySelector(`#${type}-bulk-actions`)) return;
            
            const bulkActionBar = document.createElement('div');
            bulkActionBar.id = `${type}-bulk-actions`;
            bulkActionBar.className = 'bulk-actions';
            bulkActionBar.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
                display: none;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            `;
            
            bulkActionBar.innerHTML = `
                <div class="bulk-info">
                    <div class="bulk-count" id="${type}-selected-count" style="background: rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 5px 12px; font-weight: bold;">0개 선택됨</div>
                    <span style="margin-left: 15px;">선택된 ${type === 'wordpress' ? 'WordPress' : 'Tistory'} 콘텐츠를 관리하세요</span>
                </div>
                <div>
                    <button class="btn btn-light btn-sm me-2" onclick="deselectAll('${type}')" style="font-weight: bold;">
                        <i class="bi bi-x"></i> 선택 해제
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="bulkDelete('${type}')" style="font-weight: bold;">
                        <i class="bi bi-trash"></i> 선택 삭제
                    </button>
                </div>
            `;
            
            const cardBody = cardElement.querySelector('.card-body');
            cardBody.parentNode.insertBefore(bulkActionBar, cardBody);
            console.log(`✅ ${type} 대량 작업 바 추가됨`);
        }

        // ====== 자동 발행 스케줄 관리 함수들 ======

        // 이번 주 월요일 날짜 계산
        function getThisMonday() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=일요일, 1=월요일, ..., 6=토요일
            
            // 이번 주 월요일까지의 일수 계산
            // 일요일(0) -> -6일 (이번주 월요일), 월요일(1) -> 0일, 화요일(2) -> -1일, ..., 토요일(6) -> -5일
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            
            const monday = new Date(today);
            monday.setDate(today.getDate() + daysToMonday);
            
            console.log('Today:', today.toISOString().split('T')[0], 'Day of week:', dayOfWeek, 'Days to Monday:', daysToMonday, 'Monday:', monday.toISOString().split('T')[0]);
            
            return monday.toISOString().split('T')[0];
        }

        // 전체 스케줄 보기 모달 표시
        function showScheduleOverview() {
            const modal = new bootstrap.Modal(document.getElementById('scheduleOverviewModal'));
            modal.show();
            
            // 모달이 열리면 현재 주 스케줄 로드
            showScheduleWeek('current');
            calculateNextRunTime();
        }

        // 특정 주차 스케줄 표시
        async function showScheduleWeek(weekType) {
            try {
                // 버튼 활성화 상태 변경
                document.querySelectorAll('.schedule-overview-controls .btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                const today = new Date();
                let targetDate;
                
                if (weekType === 'current') {
                    targetDate = getThisMonday();
                } else {
                    // 다음 주 월요일 = 이번 주 월요일 + 7일
                    const thisMonday = new Date(getThisMonday());
                    thisMonday.setDate(thisMonday.getDate() + 7);
                    targetDate = thisMonday.toISOString().split('T')[0];
                    console.log('다음주 계산 결과:', {
                        이번주월요일: getThisMonday(),
                        다음주월요일: targetDate,
                        thisMonday: thisMonday
                    });
                }
                
                console.log('Today:', today.toISOString().split('T')[0]);
                console.log('Calculated target date:', targetDate);
                console.log('Week type:', weekType);
                console.log('Fetching schedule for:', targetDate);
                const response = await fetch(`/api/schedule/weekly?week_start=${targetDate}`);
                
                // 디버깅: 원시 텍스트 응답 확인
                const responseText = await response.text();
                console.log('Raw response text:', responseText.substring(0, 500));
                
                const scheduleData = JSON.parse(responseText);
                
                console.log('Schedule API response:', scheduleData);
                console.log('Schedule data keys:', Object.keys(scheduleData));
                console.log('Schedule data length:', Object.keys(scheduleData).length);
                
                // 데이터 클론해서 전달
                const clonedData = JSON.parse(JSON.stringify(scheduleData));
                console.log('Cloned data for display:', clonedData);
                
                displayWeeklySchedule(clonedData);
                
            } catch (error) {
                console.error('스케줄 로드 오류:', error);
                const container = document.getElementById('schedule-overview-content') || document.getElementById('weekly-schedule-content');
                container.innerHTML = '<div class="text-center text-muted">스케줄을 불러올 수 없습니다.</div>';
            }
        }

        // 스케줄 전체 표시
        function displayScheduleOverview(scheduleData, weekType) {
            console.log('displayScheduleOverview called with:', scheduleData, weekType);
            console.log('scheduleData type:', typeof scheduleData);
            console.log('scheduleData keys:', scheduleData ? Object.keys(scheduleData) : 'null');
            console.log('scheduleData length:', scheduleData ? Object.keys(scheduleData).length : 0);
            
            const container = document.getElementById('schedule-overview-content');
            console.log('Container found:', container);
            
            if (!scheduleData || Object.keys(scheduleData).length === 0) {
                console.log('No schedule data, showing empty message');
                console.log('Condition details: scheduleData exists?', !!scheduleData, 'keys length:', scheduleData ? Object.keys(scheduleData).length : 0);
                container.innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-muted mb-3">
                            <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
                        </div>
                        <p class="text-muted">${weekType === 'current' ? '이번' : '다음'} 주 발행 계획이 자동으로 생성됩니다.</p>
                        <small class="text-muted">시스템이 자동으로 스케줄을 관리합니다.</small>
                        <div class="mt-3">
                            <small class="text-warning">DEBUG: scheduleData = ${JSON.stringify(scheduleData)}</small>
                        </div>
                    </div>
                `;
                return;
            }
            
            console.log('Schedule data passed validation, proceeding with display');
            
            // 원본 데이터를 JSON으로 출력해서 실제 구조 확인
            console.log('Raw scheduleData JSON:', JSON.stringify(scheduleData));
            console.log('First date raw data:', scheduleData['2025-08-11']);
            
            let html = `
                <div class="schedule-header mb-4">
                    <h6 class="text-primary">
                        📅 ${weekType === 'current' ? '이번' : '다음'} 주 발행 계획 
                    </h6>
                </div>
                <div class="row">
            `;
            
            // API 응답 데이터를 날짜별로 표시
            const scheduleEntries = Object.entries(scheduleData);
            console.log('Processing schedule entries:', scheduleEntries);
            scheduleEntries.forEach(([date, dayInfo]) => {
                console.log('Raw dayInfo for', date, ':', dayInfo);
                console.log('dayInfo type:', typeof dayInfo);
                console.log('dayInfo keys:', dayInfo ? Object.keys(dayInfo) : 'null');
                
                // 직접 scheduleData에서 가져오기
                const dayData = scheduleData[date];
                console.log('Direct access dayData:', dayData);
                console.log('Direct access keys:', dayData ? Object.keys(dayData) : 'null');
                
                if (!dayData || Object.keys(dayData).length === 0) {
                    console.log('No day data for date:', date);
                    return;
                }
                
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('ko-KR', { weekday: 'long' });
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card schedule-day-card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">${dayName}</h6>
                                <small class="text-muted">${date}</small>
                            </div>
                            <div class="card-body p-2">
                `;
                
                // 사이트별 계획 표시
                const sites = ['unpre', 'untab', 'skewese', 'tistory'];
                sites.forEach(site => {
                    if (dayData[site]) {
                        const plan = dayData[site];
                        
                        html += `
                            <div class="schedule-site-item mb-2 p-2 bg-light rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="site-badge site-${site} small mb-1">${site.toUpperCase()}</div>
                                        <div class="fw-bold small">${plan.time} 발행</div>
                                        <div class="text-muted small">
                                            주제: ${plan.topic || '자동 선택'}
                                        </div>
                                    </div>
                                    <span class="badge bg-info small">${plan.status || '예정'}</span>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            console.log('Generated HTML length:', html.length);
            console.log('Final HTML:', html);
            container.innerHTML = html;
            console.log('HTML inserted into container');
        }

        // 다음 실행 시간 계산
        function calculateNextRunTime() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(3, 0, 0, 0); // 새벽 3시
            
            // 만약 현재 시간이 새벽 3시 이전이면 오늘 3시로 설정
            if (now.getHours() < 3) {
                tomorrow.setDate(now.getDate());
            }
            
            const nextRunElement = document.getElementById('next-run-time');
            if (nextRunElement) {
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                };
                nextRunElement.textContent = tomorrow.toLocaleString('ko-KR', options);
            }
        }

        // 일주일치 스케줄 로드
        async function loadWeeklySchedule() {
            const weekPicker = document.getElementById('schedule-week-picker');
            const startDate = weekPicker.value || getThisMonday();
            
            try {
                console.log('📅 스케줄 로딩 시작:', startDate);
                const response = await fetch(`/api/schedule/weekly?week_start=${startDate}`);
                const scheduleData = await response.json();
                
                console.log('📊 API 응답 데이터:', scheduleData);
                console.log('📊 schedule 키 존재:', !!scheduleData.schedule);
                console.log('📊 schedule 타입:', typeof scheduleData.schedule);
                if (scheduleData.schedule) {
                    console.log('📊 schedule 키들:', Object.keys(scheduleData.schedule));
                }
                
                displayWeeklySchedule(scheduleData);
            } catch (error) {
                console.error('스케줄 로드 오류:', error);
                document.getElementById('weekly-schedule-content').innerHTML = 
                    '<div class="text-center text-muted">스케줄을 불러올 수 없습니다.</div>';
            }
        }

        // 스케줄 표시
        function displayWeeklySchedule(scheduleData) {
            console.log('🎨 displayWeeklySchedule 시작', scheduleData);
            console.log('🔍 Container search: weekly-schedule-content exists?', !!document.getElementById('weekly-schedule-content'));
            console.log('🔍 Container search: schedule-overview-content exists?', !!document.getElementById('schedule-overview-content'));
            
            const container = document.getElementById('schedule-overview-content') || document.getElementById('weekly-schedule-content');
            console.log('✅ Selected container:', container);
            
            if (!scheduleData || !scheduleData.schedule) {
                console.log('❌ 스케줄 데이터 없음:', !scheduleData, !scheduleData?.schedule);
                console.log('📊 scheduleData keys:', scheduleData ? Object.keys(scheduleData) : 'null');
                container.innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-muted mb-3">
                            <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
                        </div>
                        <p class="text-muted">해당 주의 발행 스케줄이 없습니다.</p>
                        <button class="btn btn-primary btn-sm" onclick="createWeeklySchedule()">
                            스케줄 생성하기
                        </button>
                    </div>
                `;
                return;
            }
            
            // 캘린더 스타일을 위한 CSS 추가
            const calendarCSS = `
                <style>
                .calendar-week {
                    display: grid;
                    grid-template-columns: repeat(7, 1fr);
                    gap: 1px;
                    background: #dee2e6;
                    border-radius: 8px;
                    overflow: hidden;
                    margin-bottom: 20px;
                }
                .calendar-day {
                    background: white;
                    min-height: 200px;
                    padding: 8px;
                    position: relative;
                    overflow: hidden;
                }
                .calendar-day.today {
                    background: #fff3cd;
                    border: 2px solid #ffc107;
                }
                .day-header {
                    font-size: 0.9rem;
                    font-weight: bold;
                    color: #495057;
                    margin-bottom: 8px;
                    text-align: center;
                    border-bottom: 1px solid #dee2e6;
                    padding-bottom: 4px;
                }
                .site-item {
                    margin-bottom: 4px;
                    padding: 3px 6px;
                    border-radius: 4px;
                    font-size: 0.75rem;
                    line-height: 1.2;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .site-item:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .site-unpre { background: #e3f2fd; color: #1976d2; }
                .site-untab { background: #f3e5f5; color: #7b1fa2; }
                .site-skewese { background: #e8f5e8; color: #388e3c; }
                .site-tistory { background: #fff3e0; color: #f57c00; }
                .status-published { border-left: 4px solid #28a745; }
                .status-generated { border-left: 4px solid #ffc107; }
                .status-planned { border-left: 4px solid #6c757d; }
                .time-badge {
                    position: absolute;
                    top: 4px;
                    right: 4px;
                    background: #007bff;
                    color: white;
                    font-size: 0.6rem;
                    padding: 2px 4px;
                    border-radius: 3px;
                }
                </style>
            `;
            
            let html = calendarCSS + `
                <div class="schedule-calendar-view">
                    <div class="text-center mb-4">
                        <h5><i class="bi bi-calendar-week"></i> ${scheduleData.week_start} 주간 발행 계획</h5>
                        <small class="text-muted">매일 새벽 3시 자동 발행</small>
                    </div>
                    
                    <div class="calendar-week">
            `;
            
            // 오늘 날짜
            const today = new Date().toISOString().split('T')[0];
            
            // scheduleData.schedule 객체를 순회
            console.log('🔄 스케줄 데이터 순회 시작');
            let dayCount = 0;
            for (const [dayNum, dayData] of Object.entries(scheduleData.schedule)) {
                console.log(`📅 Day ${dayNum}:`, dayData);
                dayCount++;
                
                const isToday = dayData.date === today;
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <div class="day-header">
                            ${dayData.day_name}
                            <br><small>${dayData.date}</small>
                        </div>
                        ${isToday ? '<div class="time-badge">03:00</div>' : ''}
                `;
                
                // 사이트별 스케줄 표시
                for (const [site, siteData] of Object.entries(dayData.sites)) {
                    const statusClass = `status-${siteData.status}`;
                    const siteClass = `site-${site}`;
                    
                    const statusIcon = siteData.status === 'published' ? '✅' : 
                                      siteData.status === 'generated' ? '⏳' : '📝';
                    
                    html += `
                        <div class="site-item ${siteClass} ${statusClass}" 
                             title="${siteData.topic} (${siteData.category})"
                             onclick="${siteData.url ? `window.open('${siteData.url}', '_blank')` : 'void(0)'}">
                            <div style="font-weight: bold; margin-bottom: 2px;">
                                ${statusIcon} ${site.toUpperCase()}
                            </div>
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${siteData.topic}
                            </div>
                            <div style="font-size: 0.6rem; color: #666; margin-top: 2px;">
                                ${siteData.category}
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            html += `
                    </div>
                    
                    <div class="mt-4 text-center">
                        <div class="d-flex justify-content-center gap-3 mb-3">
                            <small><span style="display:inline-block;width:12px;height:12px;background:#28a745;margin-right:4px;"></span>발행완료</small>
                            <small><span style="display:inline-block;width:12px;height:12px;background:#ffc107;margin-right:4px;"></span>생성완료</small>
                            <small><span style="display:inline-block;width:12px;height:12px;background:#6c757d;margin-right:4px;"></span>예정</small>
                        </div>
                        <small class="text-muted">💡 발행된 글을 클릭하면 새 창에서 열립니다</small>
                    </div>
                </div>
            `;
            
            console.log('✅ 최종 HTML 길이:', html.length);
            console.log('✅ 처리된 일 수:', dayCount);
            console.log('🎯 컨테이너에 HTML 설정 중...');
            container.innerHTML = html;
            console.log('🎉 스케줄 표시 완료!');
        }

        // 수동 발행 트리거
        async function triggerManualPublish() {
            const today = new Date().toISOString().split('T')[0];
            
            if (!confirm('⚠️ 오늘 예정된 모든 콘텐츠를 지금 수동으로 생성하고 발행하시겠습니까?\n\n이 작업은 자동 스케줄과 별개로 즉시 실행됩니다.')) {
                return;
            }
            
            // 진행상황 모달 생성
            const progressModal = document.createElement('div');
            progressModal.innerHTML = `
                <div class="modal fade" id="publishProgressModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">🚀 자동발행계획 수동 실행 중...</h5>
                            </div>
                            <div class="modal-body">
                                <div class="progress mb-3">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" id="publishProgress"></div>
                                </div>
                                <div id="publishStatus">발행을 시작합니다...</div>
                                <ul id="publishResults" class="mt-3"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);
            
            const modal = new bootstrap.Modal(document.getElementById('publishProgressModal'));
            modal.show();
            
            showNotification('🚀 자동발행계획에 따른 수동 발행을 시작합니다...', 'info');
            
            // 실시간 상태 폴링 시작
            const pollStatus = async () => {
                try {
                    const statusResponse = await fetch('/api/publish_status');
                    
                    // JSON 응답 확인
                    if (!statusResponse.ok) {
                        console.error('상태 조회 실패:', statusResponse.status);
                        return;
                    }
                    
                    const contentType = statusResponse.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        console.error('JSON이 아닌 응답 수신:', contentType);
                        return;
                    }
                    
                    const status = await statusResponse.json();
                    
                    const progressBar = document.getElementById('publishProgress');
                    const statusDiv = document.getElementById('publishStatus');
                    const resultsUl = document.getElementById('publishResults');
                    
                    if (progressBar) {
                        progressBar.style.width = `${status.progress}%`;
                        statusDiv.innerHTML = status.message;
                        
                        // 현재 처리 중인 사이트 표시
                        if (status.current_site) {
                            statusDiv.innerHTML += ` (현재: ${status.current_site.toUpperCase()})`;
                        }
                        
                        // 완료된 사이트 결과 표시
                        resultsUl.innerHTML = '';
                        if (status.results && Array.isArray(status.results)) {
                            status.results.forEach(result => {
                                const li = document.createElement('li');
                                li.className = result.success ? 'text-success' : 'text-danger';
                                
                                let resultText = `${result.site.toUpperCase()}: ${result.message}`;
                                if (result.topic) {
                                    resultText += ` (주제: ${result.topic})`;
                                }
                                if (result.url) {
                                    resultText += ` - <a href="${result.url}" target="_blank">발행된 글 보기</a>`;
                                }
                                
                                li.innerHTML = resultText;
                                resultsUl.appendChild(li);
                            });
                        }
                        
                        if (!status.in_progress) {
                            // 완료되면 폴링 중지
                            clearInterval(pollInterval);
                            
                            if (status.progress === 100) {
                                progressBar.className = 'progress-bar bg-success';
                                showNotification('✅ 자동발행계획 수동 실행 완료!', 'success');
                            } else {
                                progressBar.className = 'progress-bar bg-danger';
                                showNotification('❌ 발행 중 오류 발생', 'error');
                            }
                            
                            // 발행 완료 후 한 번만 새로고침
                            setTimeout(() => {
                                loadWeeklySchedule();
                                refreshData();
                            }, 1000);
                            
                            // 5초 후 모달 닫기
                            setTimeout(() => {
                                modal.hide();
                                if (progressModal && progressModal.parentNode) {
                                    progressModal.parentNode.removeChild(progressModal);
                                }
                            }, 5000);
                        }
                    }
                } catch (error) {
                    console.error('상태 폴링 오류:', error);
                }
            };
            
            // 1초마다 상태 폴링
            const pollInterval = setInterval(pollStatus, 1000);
            
            try {
                // 발행 시작 (빠른 API 사용)
                const response = await fetch('/api/quick_publish', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sites: ['unpre', 'untab', 'skewese', 'tistory']})
                });
                
                // 응답 검증
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error(`JSON이 아닌 응답: ${contentType}`);
                }
                
                const result = await response.json();
                
                // API 호출 성공 시 메시지
                if (result.success) {
                    console.log('발행 요청이 성공적으로 시작되었습니다:', result.message);
                } else {
                    console.error('발행 시작 실패:', result.message || result.error);
                    clearInterval(pollInterval);
                    showNotification(`❌ 발행 시작 실패: ${result.message || result.error || '알 수 없는 오류'}`, 'error');
                    modal.hide();
                    if (progressModal && progressModal.parentNode) {
                        progressModal.parentNode.removeChild(progressModal);
                    }
                }
                
            } catch (error) {
                clearInterval(pollInterval);
                console.error('발행 요청 오류:', error);
                showNotification(`❌ 발행 요청 오류: ${error.message}`, 'error');
                modal.hide();
                if (progressModal && progressModal.parentNode) {
                    progressModal.parentNode.removeChild(progressModal);
                }
            }
        }

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 날짜 선택기를 이번 주 월요일로 설정
            document.getElementById('schedule-week-picker').value = getThisMonday();
            
            // 스케줄 로드
            loadWeeklySchedule();
        });
        // 누락된 콘텐츠 관리 함수들
        function editContent(fileId, type) {
            alert(`${type} 콘텐츠 편집 기능 (ID: ${fileId})\n준비 중입니다.`);
        }
        
        function downloadContent(fileId, type) {
            try {
                // 다운로드 API 호출
                const downloadUrl = `/api/download_content/${fileId}`;
                
                showNotification(`🔄 ${type} 콘텐츠 다운로드 시작...`, 'info');
                
                // 직접 창 열기 방식으로 변경
                window.open(downloadUrl, '_blank');
                
                // 성공 메시지는 약간 지연 후 표시
                setTimeout(() => {
                    showNotification(`✅ ${type} 콘텐츠 다운로드가 시작되었습니다.`, 'success');
                }, 500);
                
            } catch (error) {
                console.error('다운로드 오류:', error);
                showNotification(`❌ 다운로드 중 오류가 발생했습니다.`, 'error');
            }
        }
        
        function deleteContent(fileId, type) {
            if (confirm(`정말로 이 ${type} 콘텐츠를 삭제하시겠습니까?`)) {
                // 삭제 API 호출
                fetch('/api/delete_posts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({post_ids: [fileId]})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('콘텐츠가 삭제되었습니다.', 'success');
                        // 목록 새로고침
                        refreshDataQuietly();
                    } else {
                        showNotification('삭제 실패: ' + (data.error || '알 수 없는 오류'), 'error');
                    }
                })
                .catch(error => {
                    console.error('삭제 오류:', error);
                    showNotification('삭제 중 오류가 발생했습니다.', 'error');
                });
            }
        }
        
        function publishToTistory(fileId, buttonElement) {
            if (!confirm(`Tistory에 콘텐츠를 발행하시겠습니까?`)) {
                return;
            }
            
            // 로딩 상태 표시 (버튼 요소를 안전하게 찾기)
            let button = buttonElement;
            if (!button && event && event.target) {
                button = event.target.closest('button');
            }
            
            let originalContent = '';
            if (button) {
                originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="spinner-border spinner-border-sm"></i> 발행 중...';
            }
            
            fetch('/api/publish_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    post_id: fileId,
                    site: 'tistory'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.success) {
                    alert('Tistory에 콘텐츠가 성공적으로 발행되었습니다!');
                    location.reload(); // 페이지 새로고침으로 상태 업데이트
                } else {
                    const errorMsg = (data && data.error) ? data.error : '알 수 없는 오류';
                    alert(`발행 실패: ${errorMsg}`);
                }
            })
            .catch(error => {
                console.error('발행 오류:', error);
                alert(`발행 중 오류가 발생했습니다: ${error.message}`);
            })
            .finally(() => {
                // 버튼 상태 복원
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            });
        }
        
        function publishToWordPress(fileId, buttonElement) {
            if (!confirm(`WordPress에 콘텐츠를 발행하시겠습니까?`)) {
                return;
            }
            
            // 로딩 상태 표시 (버튼 요소를 안전하게 찾기)
            let button = buttonElement;
            if (!button && event && event.target) {
                button = event.target.closest('button');
            }
            
            let originalContent = '';
            if (button) {
                originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="spinner-border spinner-border-sm"></i> 발행 중...';
            }
            
            fetch('/api/publish_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    post_id: fileId,
                    site: 'wordpress'
                })
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error(`서버에서 JSON이 아닌 응답을 받았습니다: ${response.status}`);
                }
            })
            .then(data => {
                if (data && data.success) {
                    alert('WordPress에 콘텐츠가 성공적으로 발행되었습니다!');
                    if (data.url) {
                        console.log('발행된 URL:', data.url);
                    }
                    location.reload(); // 페이지 새로고침으로 상태 업데이트
                } else {
                    const errorMsg = (data && data.error) ? data.error : '알 수 없는 오류';
                    alert(`발행 실패: ${errorMsg}`);
                }
            })
            .catch(error => {
                console.error('발행 오류:', error);
                alert(`발행 중 오류가 발생했습니다: ${error.message}`);
            })
            .finally(() => {
                // 버튼 상태 복원
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            });
        }
        
        function publishContent(fileId, site, buttonElement) {
            if (!confirm(`${site} 사이트에 콘텐츠를 발행하시겠습니까?`)) {
                return;
            }
            
            // 로딩 상태 표시 (버튼 요소를 안전하게 찾기)
            let button = buttonElement;
            if (!button && event && event.target) {
                button = event.target.closest('button');
            }
            
            let originalContent = '';
            if (button) {
                originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="spinner-border spinner-border-sm"></i> 발행 중...';
            }
            
            fetch('/api/publish_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    post_id: fileId,
                    site: site
                })
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error(`서버에서 JSON이 아닌 응답을 받았습니다: ${response.status}`);
                }
            })
            .then(data => {
                if (data && data.success) {
                    alert('콘텐츠가 성공적으로 발행되었습니다!');
                    if (data.url) {
                        console.log('발행된 URL:', data.url);
                    }
                    location.reload(); // 페이지 새로고침으로 상태 업데이트
                } else {
                    const errorMsg = (data && data.error) ? data.error : '알 수 없는 오류';
                    alert(`발행 실패: ${errorMsg}`);
                }
            })
            .catch(error => {
                console.error('발행 오류:', error);
                alert(`발행 중 오류가 발생했습니다: ${error.message}`);
            })
            .finally(() => {
                // 버튼 상태 복원
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            });
        }

    </script>
</body>
</html>